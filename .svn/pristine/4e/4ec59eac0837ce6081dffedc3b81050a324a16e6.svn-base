SELECT A.PARTNUMBER, A.MACHINEGROUP, A.PARTID, A.REVISIONNO, A.PREVREVISIONNO, A. TRIALFLAG, B.LATEST_DATE AS APPLICATIONDATE
FROM
(SELECT PARTNUMBER, MACHINEGROUP, PARTID, REVISIONNO, 
LAG(REVISIONNO, 1, 0) OVER (PARTITION BY PARTNUMBER ORDER BY REVISIONNO) AS PREVREVISIONNO, TRIALFLAG
FROM Z_SPECMTRLPROCESSSTATUS 
WHERE APPROVESTATE = '9' AND MACHINEGROUP = '51') A
JOIN
(
    SELECT p.PARTNUMBER, 
       p.MACHINEGROUP,
       p.REVISIONNO AS MAX_REVISIONNO,
       p.APPLICATIONDATE AS LATEST_DATE
    FROM (
      SELECT PARTNUMBER, 
             MACHINEGROUP,
             REVISIONNO,
             APPLICATIONDATE,
             RANK() OVER (PARTITION BY PARTNUMBER ORDER BY REVISIONNO DESC) AS RNK
      FROM Z_SPECMTRLREVISION
      WHERE MACHINEGROUP = '51'
    ) p
    WHERE p.RNK = 1 AND TO_DATE(SUBSTR(p.APPLICATIONDATE, 1, LENGTH(p.APPLICATIONDATE)-1), 'YYYYMMDD') < SYSDATE
)B
ON B.PARTNUMBER = A.PARTNUMBER AND A.REVISIONNO = B.MAX_REVISIONNO